<p id="fechaAct" disable></p>
@{
    var recetasJson = System.Text.Json.JsonSerializer.Serialize(ViewBag.Recetas ?? new List<object>());
    var fechaSeleccionada = ViewBag.Fecha as DateTime?;
    var fechaStr = fechaSeleccionada.HasValue ? fechaSeleccionada.Value.ToString("yyyy-MM-dd") : string.Empty;
}

<main class="mc-main mc-grid">

  <section class="mc-calendar card mc-calendar--large" aria-labelledby="cal-title">
    <header class="mc-calendar__header">
      <div class="mc-calendar__title">
        <h2 id="cal-title">Calendario</h2>
        <span class="mc-calendar__month"></span>
      </div>
      <div class="mc-calendar__controls">
        <button class="mc-icon-btn" id="cal-prev" title="Anterior">◀</button>
        <button class="mc-icon-btn" id="cal-today" title="Hoy">Hoy</button>
        <button class="mc-icon-btn" id="cal-next" title="Siguiente">▶</button>
      </div>
    </header>

    <div id="calendar" class="calendar-wrap"></div>

  </section>

  <aside class="mc-meals" aria-label="Comidas del día">


    <details class="mc-accordion" open>
      
      <summary class="mc-accordion__summary">
        <span>Desayuno</span>
        <span class="mc-accordion__chevron" aria-hidden="true">⌄</span>
      </summary>

      <div class="mc-accordion__content">
        <ul class="mc-recipes">

        @foreach(CalendariosxRecetas CalendariossxRecetas in @ViewBag.recetas){
          @if(CalendariossxRecetas.momento == "Desayuno" && CalendariossxRecetas.fecha == ViewBag.Fecha){
            <li class="mc-recipe">
              <div class="mc-recipe__info">
                <strong>@CalendariossxRecetas.receta.nombre</strong>
                <small>@CalendariossxRecetas.receta.descripcion</small>
              </div>
              <div class="mc-recipe__actions">

              <form method="post" action='@Url.Action("verReceta", "Home")' class="add-box" enctype="multipart/form-data">

                <input type="hidden" value="@CalendariossxRecetas.receta.nombre" name="nombreReceta"/>
                <button type="submit" class="btn-add">+</button>
              </form>
              </div>
            </li>
          }

        }
        </ul>
      </div>

    </details>



    <details class="mc-accordion" open>
      <summary class="mc-accordion__summary">
        <span>Almuerzo</span>
        <span class="mc-accordion__chevron" aria-hidden="true">⌄</span>
      </summary>

      <div class="mc-accordion__content">
        <ul class="mc-recipes">

        @foreach(CalendariosxRecetas CalendariossxRecetas in @ViewBag.recetas){
          
          @if(CalendariossxRecetas.momento == "Almuerzo" && CalendariossxRecetas.fecha == ViewBag.Fecha){
            <li class="mc-recipe">
              <div class="mc-recipe__info">
                <strong>@CalendariossxRecetas.receta.nombre</strong>
                <small>@CalendariossxRecetas.receta.descripcion</small>
              </div>
              <div class="mc-recipe__actions">

              <form method="post" action='@Url.Action("verReceta", "Home")' class="add-box">

                <input type="hidden" value="@CalendariossxRecetas.receta.nombre" name="nombreReceta"/>
                <button type="submit" class="btn-add">+</button>
              </form>
            </div>
            </li>
          }

        }
        </ul>
      </div>
    </details>

        <details class="mc-accordion" open>
      <summary class="mc-accordion__summary">
        <span>Merienda</span>
        <span class="mc-accordion__chevron" aria-hidden="true">⌄</span>
      </summary>

      <div class="mc-accordion__content">
        <ul class="mc-recipes">

        @foreach(CalendariosxRecetas CalendariosxRecetas in @ViewBag.recetas){
          
          @if(CalendariosxRecetas.momento == "Merienda" && CalendariosxRecetas.fecha == ViewBag.Fecha){
            <li class="mc-recipe">
              <div class="mc-recipe__info">
                <strong>@CalendariosxRecetas.receta.nombre</strong>
                <small>@CalendariosxRecetas.receta.descripcion</small>
              </div>
              <div class="mc-recipe__actions">
              <form method="post" action='@Url.Action("verReceta", "Home")' class="add-box">

                <input type="hidden" value="@CalendariosxRecetas.receta"/>
                <button type="submit" class="btn-add">+</button>
              </form>              </div>
            </li>
          }

        }
        </ul>

      </div>
    </details>

        <details class="mc-accordion" open>
      <summary class="mc-accordion__summary">
        <span>Cena</span>
        <span class="mc-accordion__chevron" aria-hidden="true">⌄</span>
      </summary>

      <div class="mc-accordion__content">
        <ul class="mc-recipes">

        @foreach(CalendariosxRecetas CalendariosxRecetas in @ViewBag.recetas){
          
          @if(CalendariosxRecetas.momento == "Cena" && CalendariosxRecetas.fecha == ViewBag.Fecha){
            <li class="mc-recipe">
              <div class="mc-recipe__info">
                <strong>@CalendariosxRecetas.receta.nombre</strong>
                <small>@CalendariosxRecetas.receta.descripcion</small>
              </div>
              <div class="mc-recipe__actions">

              <form method="post" action='@Url.Action("verReceta", "Home")' class="add-box">

                <input type="hidden" value="@CalendariosxRecetas.receta"/>
                <button type="submit" class="btn-add">+</button>
              </form>              </div>
            </li>
          }

        }
        </ul>
      </div>
    </details>
  </aside>
  <form id="form" method="POST" action='@Url.Action("verCalendario", "Home")' enctype="multipart/form-data">
    <input type="hidden" id="fechaInput" name="fecha" />
  </form>

</main>

<script>

document.addEventListener('DOMContentLoaded', () => {
  const calendarEl = document.getElementById('calendar');
  const monthSpan = document.querySelector('.mc-calendar__month');
  const btnPrev = document.getElementById('cal-prev');
  const btnNext = document.getElementById('cal-next');
  const btnToday = document.getElementById('cal-today');

  const recetas = @Html.Raw(recetasJson);

  const eventos = recetas.map(r => ({
    title: `${r.momento.toUpperCase()}: ${r.receta.nombre}`,
    start: (r.fecha || '').split('T')[0],
    color: r.momento === 'Desayuno' ? '#6CA542' :
           r.momento === 'Almuerzo' ? '#FFD700' :
           r.momento === 'Cena' ? '#FF6347' : '#888'
  }));

  // set a responsive height: big on desktop, moderate on mobile
  const calcHeight = () => Math.max(480, Math.min(920, window.innerHeight - 220));

  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    locale: 'es',
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: 'dayGridMonth,timeGridWeek'
    },
    height: calcHeight(),
    expandRows: true,
    dayMaxEventRows: 4,
    events: eventos,
    eventDisplay: 'block',
    dateClick: function(info) {
      // submit the selected date to the server
      document.getElementById("fechaInput").value = info.dateStr;
      document.getElementById('form').submit();
    },
    datesSet: (info) => {
      const startDate = info.start;
      const options = { month: 'long', year: 'numeric' };
      const formatted = startDate.toLocaleDateString('es-AR', options);
      monthSpan.textContent = formatted.charAt(0).toUpperCase() + formatted.slice(1);
    }
  });

  calendar.render();

  // connect our custom prev/today/next buttons to the calendar
  btnPrev?.addEventListener('click', () => calendar.prev());
  btnNext?.addEventListener('click', () => calendar.next());
  btnToday?.addEventListener('click', () => calendar.today());

  // update month label for initial render
  const today = calendar.getDate();
  const options = { month: 'long', year: 'numeric' };
  const formatted = today.toLocaleDateString('es-AR', options);
  monthSpan.textContent = formatted.charAt(0).toUpperCase() + formatted.slice(1);

  // responsive: adjust height on resize
  let resizeTimer;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(() => {
      calendar.setOption('height', calcHeight());
    }, 120);
  });
});
    </script>

